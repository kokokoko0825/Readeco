# バーコード読み取りトラブルシューティングガイド

バーコードの読み取り成功率が端末によって異なる場合の原因と対策をまとめます。

## 主な原因

### 1. カメラの性能差

**原因:**
- 端末のカメラセンサーの品質
- 解像度の違い
- オートフォーカスの性能
- 処理速度の違い

**対策:**
- カメラの解像度を端末の性能に応じて自動調整
- オートフォーカスを有効化
- ズーム機能を使用してバーコードを大きく表示

### 2. 照明条件

**原因:**
- 暗い場所での読み取り
- 反射光による読み取り失敗
- バーコード表面の汚れ

**対策:**
- 十分な照明を確保
- トーチ（フラッシュライト）を使用（Web環境では一部端末のみサポート）
- バーコードを清潔に保つ
- 反射を避ける角度でスキャン

### 3. プラットフォームの違い

**Web環境 (Chrome, Safari等):**
- @zxing/libraryを使用
- getUserMediaでカメラアクセス
- ブラウザによってAPIのサポート状況が異なる

**iOS:**
- expo-cameraのCameraViewを使用
- iOSのネイティブバーコードスキャンAPI
- 一般的に高い精度

**Android:**
- expo-cameraのCameraViewを使用
- Google ML KitまたはZXing
- 端末のハードウェア性能に依存

## 実装した改善策

### Web環境の改善

1. **カメラ解像度の最適化**
   ```javascript
   width: { ideal: 1920, min: 640 }
   height: { ideal: 1080, min: 480 }
   ```
   - 高性能端末: 1920x1080
   - 低性能端末: 最低640x480まで自動調整

2. **オートフォーカスの有効化**
   ```javascript
   focusMode: 'continuous'
   exposureMode: 'continuous'
   whiteBalanceMode: 'continuous'
   ```

3. **ズーム機能**
   - 自動的に30%ズームイン
   - バーコードが大きく表示され読み取りやすい

4. **フレームレートの最適化**
   ```javascript
   frameRate: { ideal: 30, max: 60 }
   ```

### ネイティブ環境の改善

1. **CameraViewの設定**
   ```javascript
   autofocus="on"
   zoom={0}
   mode="picture"
   ```

2. **バーコードタイプの指定**
   ```javascript
   barcodeTypes: ['ean13', 'ean8', 'upc_a', 'upc_e']
   ```
   - ISBN用のバーコード形式のみを指定
   - 検出精度が向上

## 使用時のベストプラクティス

### 1. スキャン距離
- **最適距離:** バーコードから10-15cm
- **近すぎる:** フォーカスが合わない
- **遠すぎる:** バーコードが小さすぎて読み取れない

### 2. スキャン角度
- バーコードをカメラに対して垂直に保つ
- 反射を避けるため、少し傾ける場合もある

### 3. 照明
- 明るい場所でスキャン
- 暗い場所では端末のライトを使用
- 直接光源を避ける

### 4. バーコードの状態
- 汚れや傷がないこと
- 折れ曲がっていないこと
- カバーフィルムが貼られていないこと

## デバッグ方法

### ブラウザのコンソールで確認

1. **カメラの性能情報**
   ```
   Camera capabilities: { ... }
   Camera settings: { ... }
   ```

2. **スキャン状況**
   ```
   Scanning... (30 frames)
   Barcode scanned: 9784XXXXXXXXX
   ```

3. **エラーメッセージ**
   ```
   Barcode scan error: NotFoundException
   ```

### トラブルシューティング手順

1. **ブラウザのコンソールを開く**
   - Chrome: F12キー → Consoleタブ
   - Safari: 開発 → JavaScriptコンソールを表示

2. **カメラの性能情報を確認**
   - `Camera capabilities`を確認
   - `zoom`, `focusMode`などのサポート状況を確認

3. **スキャンログを確認**
   - `Scanning...`メッセージが表示されているか
   - エラーが頻発していないか

4. **端末の設定を確認**
   - カメラの権限が許可されているか
   - ブラウザが最新版か
   - OSが最新版か

## よくある問題と解決策

### Q1. バーコードが全く読み取れない

**解決策:**
1. カメラの権限を確認
2. ブラウザ/アプリを再起動
3. 端末を再起動
4. 照明を改善
5. バーコードを清掃

### Q2. 読み取りが遅い

**解決策:**
1. バーコードをカメラに近づける
2. 手ブレを防ぐ（端末を固定）
3. 明るい場所でスキャン
4. クールダウン時間（2秒）が経過するまで待つ

### Q3. 特定の端末でのみ読み取れない

**解決策:**
1. 端末のカメラ性能を確認
2. ブラウザを変更（Chrome推奨）
3. OSをアップデート
4. 別の端末を試す

### Q4. Web版で読み取れないがネイティブアプリでは読み取れる

**原因:**
- ブラウザのAPIサポート状況
- カメラAPIの制限

**解決策:**
1. Chromeブラウザを使用（最もサポートが充実）
2. HTTPSで接続（カメラAPIはHTTPSが必須）
3. ブラウザを最新版にアップデート

## 推奨環境

### Web環境
- **ブラウザ:** Chrome 90+, Safari 14.1+, Edge 90+
- **OS:** iOS 14+, Android 10+, Windows 10+, macOS 11+
- **接続:** HTTPS必須

### ネイティブ環境
- **iOS:** iOS 14.0+
- **Android:** Android 10.0+ (API level 29+)

## パフォーマンスの最適化

### 端末性能別の推奨設定

**ハイエンド端末:**
- 解像度: 1920x1080
- フレームレート: 60fps
- ズーム: 30%

**ミドルレンジ端末:**
- 解像度: 1280x720
- フレームレート: 30fps
- ズーム: 20%

**ローエンド端末:**
- 解像度: 640x480
- フレームレート: 30fps
- ズーム: 10%

## サポート

バーコード読み取りに関する問題が解決しない場合:

1. 端末情報を記録（モデル、OS、ブラウザ）
2. コンソールログのスクリーンショット
3. バーコードの種類（EAN-13等）
4. エラーメッセージ

これらの情報を開発チームに報告してください。
